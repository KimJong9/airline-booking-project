

# 먼저 인증서 발급:  acm 에서 도메인 구입 후 도메인 명으로 하나 생성. 


1. 먼저 ingress 파일에 해당 내용들 적용

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: zigiingress
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    # alb.ingress.kubernetes.io/load-balancer-arn: arn:aws:elasticloadbalancing:ap-northeast-2:730335464445:loadbalancer/app/my-cluster-alb/15af0753a5725c69  # 바꾸기
    alb.ingress.kubernetes.io/backend-protocol: HTTP  # 백엔드 프로토콜 설정
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:730335464445:certificate/8d91083d-7f51-4b6f-a90f-7a1eb36d898b  # ACM에서 발급받은 인증서 ARN
    alb.ingress.kubernetes.io/healthcheck-path: /health  # 헬스 체크 경로
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '15'  # 헬스 체크 주기 (초 단위)
    alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-2016-08
    alb.ingress.kubernetes.io/actions.ssl-redirect: |
         {"Type":"redirect","RedirectConfig":{"Protocol":"HTTPS","Port":"443","StatusCode":"HTTP_301"}}
spec:
  ingressClassName: alb  # ingressClassName으로 변경
  rules:
    - http:
        paths:
          - pathType: Prefix
            path: /
            backend:
              service:
                name: mario
                port:
                  number: 80


2. 생성된 alb 경로와 동일하게 기존 alb에 경로 이식

3. kubectl edit ingress 로 ingress 파일 부분에서 arn을 기존 arn으로 수정. + 새로생성 로드벨런서의 대상 그룹도 이식

4. 새로 생성된 alb 삭제 일정 시간 후에 바뀜. 

5. 잘 작동되는지 확인. > 기존 로드벨런서 dns 주소로 확인

6. route 53에서 도메인 연동


